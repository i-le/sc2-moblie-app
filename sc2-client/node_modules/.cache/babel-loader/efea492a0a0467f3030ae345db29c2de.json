{"ast":null,"code":"import \"antd-mobile/lib/badge/style/css\";\nimport _Badge from \"antd-mobile/lib/badge\";\nimport \"antd-mobile/lib/list/style/css\";\nimport _List from \"antd-mobile/lib/list\";\nvar _jsxFileName = \"/Users/s/Desktop/react/sc2-app/sc2-client/src/containers/message/message.js\";\n\n/* \nmessage interface component\n*/\nimport React from 'react';\nimport { connect } from 'react-redux';\nconst Item = _List.Item;\nconst Brief = Item.Brief;\n\nfunction getLastMsgs(chatMsgs, userid) {\n  // 1.find each target's lastMsg，save {chat_id: lastMsg} as one object\n  const lastMsgObj = {};\n  chatMsgs.forEach(msg => {\n    /* \n    getting unread message\n    */\n    // a.对msg进行个体统计(别人发给你，且read标识为未读)\n    if (msg.to === userid && !msg.read) {\n      msg.unReadCount = 1;\n    } else {\n      msg.unReadCount = 0;\n    }\n\n    const chatId = msg.chat_id; // getting saved lastMsg\n\n    let lastMsg = lastMsgObj[chatId];\n\n    if (!lastMsg) {\n      lastMsgObj[chatId] = msg;\n    } else {\n      // b.累加unReadCount = 已统计的 + 当前msg的\n      const unReadCount = lastMsg.unReadCount + msg.unReadCount; // 如果msg比lastMsg晚，就将msg保存为lastMsg\n\n      if (msg.create_time > lastMsg.create_time) {\n        lastMsgObj[chatId] = msg;\n      } // c.将unReadCount保存在最新的lastMsg上\n\n\n      lastMsgObj[chatId].unReadCount = unReadCount;\n    }\n  }); // 2.tunring into lastMsg array\n\n  const lastMsgs = Object.values(lastMsgObj); // 3.time orded sorting\n\n  lastMsgs.sort(function (m1, m2) {\n    // result < 0, m1 infront of m2\n    return m2.create_time - m1.create_time;\n  });\n  console.log(\"function_getLastMsgs -> lastMsgs\", lastMsgs);\n  return lastMsgs;\n}\n\nclass Message extends React.Component {\n  render() {\n    const {\n      user\n    } = this.props;\n    const {\n      users,\n      chatMsgs\n    } = this.props.chat; // 对chatMsg按chat_id进行分组，取出每组最后一条\n\n    const lastMsgs = getLastMsgs(chatMsgs, user._id);\n    return /*#__PURE__*/React.createElement(_List, {\n      style: {\n        marginTop: 50,\n        marginBottom: 50\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 66,\n        columnNumber: 7\n      }\n    }, lastMsgs.map(msg => {\n      // 目标用户id\n      //const targetUserId = msg.to === user._id ? msg.from : msg.to\n      // 目标用户信息\n      //const targetUser = users.targetUserId\n      return /*#__PURE__*/React.createElement(Item, {\n        extra: /*#__PURE__*/React.createElement(_Badge, {\n          text: msg.unReadCount,\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 74,\n            columnNumber: 28\n          }\n        }),\n        thumb: msg.avatar ? require(`../../assets/sc2avatars/${msg.avatar}.png`) : null,\n        arrow: \"horizontal\",\n        key: msg.chat_id,\n        onClick: () => this.props.history.push(`/chat/${msg}`),\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 74,\n          columnNumber: 15\n        }\n      }, msg.content, /*#__PURE__*/React.createElement(Brief, {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 81,\n          columnNumber: 17\n        }\n      }, msg.username));\n    }));\n  }\n\n}\n\nexport default connect(state => ({\n  user: state.user,\n  chat: state.chat\n}), {})(Message);","map":{"version":3,"sources":["/Users/s/Desktop/react/sc2-app/sc2-client/src/containers/message/message.js"],"names":["React","connect","Item","Brief","getLastMsgs","chatMsgs","userid","lastMsgObj","forEach","msg","to","read","unReadCount","chatId","chat_id","lastMsg","create_time","lastMsgs","Object","values","sort","m1","m2","console","log","Message","Component","render","user","props","users","chat","_id","marginTop","marginBottom","map","avatar","require","history","push","content","username","state"],"mappings":"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","sourcesContent":["/* \nmessage interface component\n*/\nimport React from 'react'\nimport {connect} from 'react-redux'\nimport {List, Badge} from 'antd-mobile'\n\nconst Item = List.Item\nconst Brief = Item.Brief\n\nfunction getLastMsgs(chatMsgs, userid) {\n  // 1.find each target's lastMsg，save {chat_id: lastMsg} as one object\n  const lastMsgObj = {}\n  chatMsgs.forEach(msg => {\n\n    /* \n    getting unread message\n    */\n    // a.对msg进行个体统计(别人发给你，且read标识为未读)\n    if (msg.to === userid && !msg.read) {\n      msg.unReadCount = 1\n    } else {\n      msg.unReadCount = 0\n    }\n\n    const chatId = msg.chat_id\n    // getting saved lastMsg\n    let lastMsg = lastMsgObj[chatId]\n    if (!lastMsg) {\n      lastMsgObj[chatId] = msg\n    } else {\n      \n      // b.累加unReadCount = 已统计的 + 当前msg的\n      const unReadCount = lastMsg.unReadCount + msg.unReadCount\n\n      // 如果msg比lastMsg晚，就将msg保存为lastMsg\n      if (msg.create_time > lastMsg.create_time) {\n        lastMsgObj[chatId] = msg\n      }\n\n      // c.将unReadCount保存在最新的lastMsg上\n      lastMsgObj[chatId].unReadCount = unReadCount\n    }\n  })\n  // 2.tunring into lastMsg array\n  const lastMsgs = Object.values(lastMsgObj)\n  // 3.time orded sorting\n  lastMsgs.sort(function (m1, m2) {\n    // result < 0, m1 infront of m2\n    return m2.create_time - m1.create_time\n  })\n\n  console.log(\"function_getLastMsgs -> lastMsgs\", lastMsgs)\n  return lastMsgs\n}\n\nclass Message extends React.Component {\n \n  render() {\n    const {user} = this.props\n    const {users, chatMsgs} = this.props.chat\n    // 对chatMsg按chat_id进行分组，取出每组最后一条\n    const lastMsgs = getLastMsgs(chatMsgs, user._id)\n\n    return(\n      <List style={{marginTop: 50, marginBottom: 50}}>\n        {\n          lastMsgs.map(msg => {\n            // 目标用户id\n            //const targetUserId = msg.to === user._id ? msg.from : msg.to\n            // 目标用户信息\n            //const targetUser = users.targetUserId\n            return (\n              <Item extra={<Badge text={msg.unReadCount} />}\n                thumb={msg.avatar ? require(`../../assets/sc2avatars/${msg.avatar}.png`) : null}\n                arrow='horizontal'\n                key={msg.chat_id}\n                onClick={() => this.props.history.push(`/chat/${msg}`)}\n              >\n                {msg.content}\n                <Brief>{msg.username}</Brief>\n              </Item>\n            )\n          })\n        }\n      </List>\n    )\n  }\n}\n\nexport default connect(\n  state => ({user: state.user, chat: state.chat}),\n  {}\n)(Message)"]},"metadata":{},"sourceType":"module"}