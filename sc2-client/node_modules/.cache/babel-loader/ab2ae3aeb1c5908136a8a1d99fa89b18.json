{"ast":null,"code":"import\"antd-mobile/lib/grid/style/css\";import _Grid from\"antd-mobile/lib/grid\";import\"antd-mobile/lib/input-item/style/css\";import _InputItem from\"antd-mobile/lib/input-item\";import\"antd-mobile/lib/nav-bar/style/css\";import _NavBar from\"antd-mobile/lib/nav-bar\";import\"antd-mobile/lib/icon/style/css\";import _Icon from\"antd-mobile/lib/icon\";import _classCallCheck from\"/Users/s/Desktop/react/sc2-app/sc2-client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/s/Desktop/react/sc2-app/sc2-client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _inherits from\"/Users/s/Desktop/react/sc2-app/sc2-client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"/Users/s/Desktop/react/sc2-app/sc2-client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";import\"antd-mobile/lib/list/style/css\";import _List from\"antd-mobile/lib/list\";import React from'react';import{connect}from'react-redux';import{sendMsg,readMsg}from'../../redux/Actions';import QueueAnim from'rc-queue-anim';var Item=_List.Item;var Chat=/*#__PURE__*/function(_React$Component){_inherits(Chat,_React$Component);var _super=_createSuper(Chat);function Chat(){var _this;_classCallCheck(this,Chat);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_super.call.apply(_super,[this].concat(args));_this.state={// 当前一条消息\ncontent:'',// 是否显示表情包列表\nisShowEmojis:false};_this.handleSend=function(){// 收集数据\nvar from=_this.props.user._id;var to=_this.props.match.params.userid;var content=_this.state.content.trim();// 发送请求（发消息）\nif(content){_this.props.sendMsg({from:from,to:to,content:content});}// 重置\n_this.setState({content:'',isShowEmojis:false});};_this.toggleShow=function(){// 异步手动派发resize事件，解决表情列表自身显示bug\nvar isShowEmojis=!_this.state.isShowEmojis;_this.setState({isShowEmojis:isShowEmojis});if(isShowEmojis){setTimeout(function(){window.dispatchEvent(new Event('resize'));},0);}};return _this;}_createClass(Chat,[{key:\"componentWillMount\",// 在第一次render()之前回调\nvalue:function componentWillMount(){// 初始化表情列表数据\nvar emojis=['😀','😁','🤣','😀','😁','🤣','😀','😁','🤣','😀','😁','🤣','😀','😁','🤣','😀','😁','🤣','😀','😁','🤣','😀','😁','🤣','😁','🤣','😀','😁','🤣','😀','😁','🤣','😀','😁','🤣','😁','🤣','😀','😁','🤣','😀','😁','🤣','😀','😁','🤣'];this.emojis=emojis.map(function(emoji){return{text:emoji};});}},{key:\"componentDidMount\",value:function componentDidMount(){// 初次进入时，定位到底部\nwindow.scrollTo(0,document.body.scrollHeight);// 发送请求，更新消息未读状态\n// const from = this.props.match.params.userid\n// const to = this.props.user._id\n// this.props.readMsg(from, to)\n}},{key:\"componentDidUpdate\",value:function componentDidUpdate(){// 发送消息后，定位到底部\nwindow.scrollTo(0,document.body.scrollHeight);}},{key:\"componentWillUnmount\",value:function componentWillUnmount(){/* 解决从聊天界面退出，不更新已读问题（异步请求，显示有延时） */var from=this.props.match.params.userid;var to=this.props.user._id;this.props.readMsg(from,to);}},{key:\"render\",value:function render(){var _this2=this;var user=this.props.user;var _this$props$chat=this.props.chat,users=_this$props$chat.users,chatMsgs=_this$props$chat.chatMsgs;// debugger\n// chatMsgs: A和所有人聊天消息，过滤出和B的聊天\nvar meId=user._id;// 如果没有获取到数据，直接不做任何处理（解决刷新，清除users出现的异常）\nif(!users[meId]){return null;}var targetId=this.props.match.params.userid;var chatId=[meId,targetId].sort().join('_');var msgs=chatMsgs.filter(function(msg){return msg.chat_id===chatId;});// msg target's avatar\nvar targetAvatar=users[targetId].avatar;var targetIcon=targetAvatar?require(\"../../assets/sc2avatars/\".concat(targetAvatar,\".png\")):null;return/*#__PURE__*/React.createElement(\"div\",{className:\"chat-page\"},/*#__PURE__*/React.createElement(_NavBar,{className:\"sticky-header\",icon:/*#__PURE__*/React.createElement(_Icon,{type:\"left\"}),onLeftClick:function onLeftClick(){return _this2.props.history.goBack();}},users[targetId].username),/*#__PURE__*/React.createElement(_List,{style:{marginTop:50,marginBottom:50}},/*#__PURE__*/React.createElement(QueueAnim,{type:\"alpha\",delay:100},msgs.map(function(msg){if(targetId===msg.from){// target sending msg to me\nreturn/*#__PURE__*/React.createElement(Item,{key:msg._id,thumb:targetIcon},msg.content);}else{// sending msg to my target\nreturn/*#__PURE__*/React.createElement(Item,{key:msg._id,className:\"chat-me\",extra:\"Me\"},msg.content);}}))),/*#__PURE__*/React.createElement(\"div\",{className:\"am-tab-bar\"},/*#__PURE__*/React.createElement(_InputItem,{placeholder:\"Typing..\",extra:/*#__PURE__*/React.createElement(\"div\",{style:{padding:5}},/*#__PURE__*/React.createElement(\"span\",{role:\"img\",\"aria-label\":\"smile\",onClick:this.toggleShow,style:{marginRight:5}},\"\\uD83D\\uDE00\"),/*#__PURE__*/React.createElement(\"span\",{onClick:this.handleSend},\"Send\")),onChange:function onChange(val){return _this2.setState({content:val});},value:this.state.content,onFocus:function onFocus(){return _this2.setState({isShowEmojis:false});}}),this.state.isShowEmojis?/*#__PURE__*/React.createElement(_Grid,{data:this.emojis,columnNum:8,carouselMaxRow:4,isCarousel:true,onClick:function onClick(item){return _this2.setState({content:_this2.state.content+item.text});}}):null));}}]);return Chat;}(React.Component);export default connect(function(state){return{user:state.user,chat:state.chat};},{sendMsg:sendMsg,readMsg:readMsg})(Chat);","map":{"version":3,"sources":["/Users/s/Desktop/react/sc2-app/sc2-client/src/containers/chat/chat.js"],"names":["React","connect","sendMsg","readMsg","QueueAnim","Item","Chat","state","content","isShowEmojis","handleSend","from","props","user","_id","to","match","params","userid","trim","setState","toggleShow","setTimeout","window","dispatchEvent","Event","emojis","map","emoji","text","scrollTo","document","body","scrollHeight","chat","users","chatMsgs","meId","targetId","chatId","sort","join","msgs","filter","msg","chat_id","targetAvatar","avatar","targetIcon","require","history","goBack","username","marginTop","marginBottom","padding","marginRight","val","item","Component"],"mappings":"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","sourcesContent":["import React from 'react'\nimport {connect} from 'react-redux'\nimport {NavBar, List, InputItem, Grid, Icon} from 'antd-mobile'\nimport {sendMsg, readMsg} from '../../redux/Actions'\nimport QueueAnim from 'rc-queue-anim'\n\nconst Item = List.Item\n\n\nclass Chat extends React.Component {\n  state = {\n    // 当前一条消息\n    content: '',\n    // 是否显示表情包列表\n    isShowEmojis: false\n  }\n\n  handleSend = () => {\n    // 收集数据\n    const from = this.props.user._id \n    const to = this.props.match.params.userid\n    const content = this.state.content.trim()\n    // 发送请求（发消息）\n    if (content) {\n      this.props.sendMsg({from, to, content})\n    }\n    // 重置\n    this.setState({\n      content: '',\n      isShowEmojis: false\n    })\n  }\n\n  toggleShow = () => {\n    // 异步手动派发resize事件，解决表情列表自身显示bug\n    const isShowEmojis = !this.state.isShowEmojis\n    this.setState({\n      isShowEmojis\n    })\n    if (isShowEmojis) {\n      setTimeout(() => {\n        window.dispatchEvent(new Event('resize'))\n      }, 0)\n    }\n  }\n\n  // 在第一次render()之前回调\n  componentWillMount() {\n    // 初始化表情列表数据\n    const emojis =  ['😀', '😁', '🤣','😀', '😁', '🤣','😀', '😁', '🤣','😀', '😁', '🤣','😀'\n    ,'😁', '🤣','😀', '😁', '🤣','😀', '😁', '🤣','😀', '😁', '🤣'\n    ,'😁', '🤣','😀', '😁', '🤣','😀', '😁', '🤣','😀', '😁', '🤣'\n    ,'😁', '🤣','😀', '😁', '🤣','😀', '😁', '🤣','😀', '😁', '🤣']\n    this.emojis = emojis.map(emoji => ({text: emoji}))\n  }\n\n  componentDidMount() {\n    // 初次进入时，定位到底部\n    window.scrollTo(0, document.body.scrollHeight)\n\n    // 发送请求，更新消息未读状态\n    // const from = this.props.match.params.userid\n    // const to = this.props.user._id\n    // this.props.readMsg(from, to)\n  }\n\n  componentDidUpdate() {\n    // 发送消息后，定位到底部\n    window.scrollTo(0, document.body.scrollHeight)\n  }\n\n  componentWillUnmount() {\n    /* 解决从聊天界面退出，不更新已读问题（异步请求，显示有延时） */\n    const from = this.props.match.params.userid\n    const to = this.props.user._id\n    this.props.readMsg(from, to)\n  }\n\n  render() {\n    const {user} = this.props\n    const {users, chatMsgs} = this.props.chat\n    // debugger\n    // chatMsgs: A和所有人聊天消息，过滤出和B的聊天\n    const meId = user._id\n    // 如果没有获取到数据，直接不做任何处理（解决刷新，清除users出现的异常）\n    if (!users[meId]) {\n      return null\n    }\n    const targetId = this.props.match.params.userid\n    const chatId = [meId, targetId].sort().join('_')\n\n    const msgs = chatMsgs.filter(msg => msg.chat_id === chatId)\n\n    // msg target's avatar\n    const targetAvatar = users[targetId].avatar\n    const targetIcon = targetAvatar ? require(`../../assets/sc2avatars/${targetAvatar}.png`) : null\n    return (\n      <div className=\"chat-page\">\n        <NavBar className='sticky-header' \n          icon={<Icon type='left' />}\n          onLeftClick={() => this.props.history.goBack()}\n          >\n          {users[targetId].username}\n        </NavBar>\n        <List style={{marginTop: 50, marginBottom: 50}}>\n            <QueueAnim type='alpha' delay={100}>\n            {\n              msgs.map(msg => {\n                if (targetId === msg.from) {\n                  // target sending msg to me\n                  return (\n                    <Item key={msg._id} thumb={targetIcon}>\n                      {msg.content}\n                    </Item>\n                  )\n                } else {\n                  // sending msg to my target\n                  return (\n                    <Item key={msg._id} className='chat-me' extra='Me'>\n                      {msg.content}\n                    </Item>\n                  )\n                }\n              })\n            }\n            </QueueAnim>\n        </List>\n        <div className=\"am-tab-bar\">\n          <InputItem placeholder=\"Typing..\"\n            extra={\n              <div style={{padding: 5}}>\n                {/* <span onClick={() => this.setState({isShowEmojis: true})}\n                  style={{marginRight: 5}}\n                  >\n                  😀\n                </span> */}\n                <span role=\"img\" aria-label=\"smile\" onClick={this.toggleShow} style={{marginRight: 5}}>😀</span>\n                <span onClick={this.handleSend}>Send</span>\n              </div>\n            }\n            onChange={val => this.setState({content: val})}\n            value={this.state.content}\n            onFocus={() => this.setState({isShowEmojis: false})}\n          />\n          {\n            this.state.isShowEmojis ? (\n              <Grid data={this.emojis}\n                columnNum={8}\n                carouselMaxRow={4}\n                isCarousel={true}\n                onClick={item => this.setState({content: this.state.content + item.text})}\n                >\n              </Grid>\n            ) : null\n          }\n        </div>\n      </div>\n    )\n  }\n}\n\nexport default connect(\n  state => ({user: state.user, chat: state.chat}),\n  {sendMsg, readMsg}\n)(Chat)"]},"metadata":{},"sourceType":"module"}